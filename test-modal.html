<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Modal Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #10a37f;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #0d8f6b;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Supabase Configuration Modal Test</h1>
        <p>æµ‹è¯•æ–°çš„ Supabase é…ç½®æ¨¡æ€æ¡†åŠŸèƒ½</p>
        
        <button class="test-button" onclick="testModal()">æ‰“å¼€é…ç½®æ¨¡æ€æ¡†</button>
        <button class="test-button" onclick="testWithExistingConfig()">æ‰“å¼€é…ç½®æ¨¡æ€æ¡† (é¢„å¡«å……æ•°æ®)</button>
        <button class="test-button" onclick="clearConfig()">æ¸…é™¤é…ç½®</button>
        <button class="test-button" onclick="showCurrentConfig()">æ˜¾ç¤ºå½“å‰é…ç½®</button>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        // Mock CONFIG object
        const CONFIG = {
            SUPABASE_URL: null,
            SUPABASE_ANON_KEY: null,
            TABLE_NAME: null,
            get: function(key) {
                if (this[key] !== null) return this[key];
                const stored = localStorage.getItem(`chatsyncer_${key.toLowerCase()}`);
                if (stored) {
                    this[key] = stored;
                    return stored;
                }
                return null;
            },
            set: function(key, value) {
                this[key] = value;
                localStorage.setItem(`chatsyncer_${key.toLowerCase()}`, value);
            }
        };

        // Modal implementation (extracted from userscript)
        const UI = {
            promptConfig() {
                return new Promise((resolve) => {
                    this.showConfigModal(resolve);
                });
            },

            showConfigModal(callback) {
                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 10002;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                // Create modal content
                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                    max-height: 80vh;
                    overflow-y: auto;
                `;

                modal.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h2 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #1f2937;">é…ç½® Supabase è¿æ¥</h2>
                        <p style="margin: 0; font-size: 14px; color: #6b7280;">è¯·å¡«å…¥æ‚¨çš„ Supabase é¡¹ç›®ä¿¡æ¯</p>
                    </div>

                    <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; line-height: 1.5;">
                        <strong>ğŸ“‹ å¦‚ä½•è·å– Supabase å¯†é’¥ï¼š</strong><br>
                        1. ç™»å½• <a href="https://supabase.com" target="_blank" style="color: #10a37f;">Supabase</a> å¹¶è¿›å…¥æ‚¨çš„é¡¹ç›®<br>
                        2. åœ¨å·¦ä¾§èœå•ç‚¹å‡» "Settings" â†’ "API"<br>
                        3. å¤åˆ¶ "Project URL" å’Œ "anon public" å¯†é’¥<br>
                        4. ç¡®ä¿åœ¨ "Authentication" â†’ "Policies" ä¸­è®¾ç½®äº†æ­£ç¡®çš„ RLS ç­–ç•¥
                    </div>

                    <form id="supabaseConfigForm">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">
                                Supabase URL *
                            </label>
                            <input type="url" id="supabaseUrl" placeholder="https://your-project.supabase.co" 
                                   style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box;"
                                   value="${CONFIG.get('SUPABASE_URL') || ''}" required>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">
                                åŒ¿åå¯†é’¥ (anon key) *
                            </label>
                            <textarea id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." rows="3"
                                      style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical; box-sizing: border-box;"
                                      required>${CONFIG.get('SUPABASE_ANON_KEY') || ''}</textarea>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">
                                è¡¨å
                            </label>
                            <input type="text" id="tableName" placeholder="chat_logs" 
                                   style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box;"
                                   value="${CONFIG.get('TABLE_NAME') || 'chat_logs'}">
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button type="button" id="cancelConfig" 
                                    style="padding: 10px 16px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; font-size: 14px; cursor: pointer;">
                                å–æ¶ˆ
                            </button>
                            <button type="submit" id="saveConfig"
                                    style="padding: 10px 16px; border: none; background: #10a37f; color: white; border-radius: 6px; font-size: 14px; cursor: pointer;">
                                ä¿å­˜é…ç½®
                            </button>
                        </div>
                    </form>
                `;

                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                // Handle form submission
                const form = modal.querySelector('#supabaseConfigForm');
                const cancelBtn = modal.querySelector('#cancelConfig');

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const url = document.getElementById('supabaseUrl').value.trim();
                    const key = document.getElementById('supabaseKey').value.trim();
                    const table = document.getElementById('tableName').value.trim() || 'chat_logs';

                    if (!url || !key) {
                        alert('è¯·å¡«å†™ URL å’Œå¯†é’¥');
                        return;
                    }

                    CONFIG.set('SUPABASE_URL', url.replace(/\/$/, ''));
                    CONFIG.set('SUPABASE_ANON_KEY', key);
                    CONFIG.set('TABLE_NAME', table);

                    document.body.removeChild(overlay);
                    callback(true);
                });

                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    callback(false);
                });

                // Close modal when clicking overlay
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        callback(false);
                    }
                });

                // Focus first input
                setTimeout(() => {
                    document.getElementById('supabaseUrl').focus();
                }, 100);
            }
        };

        // Test functions
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function testModal() {
            log('Opening configuration modal...');
            try {
                const result = await UI.promptConfig();
                log(`Modal result: ${result}`);
                if (result) {
                    log('Configuration saved successfully');
                    showCurrentConfig();
                } else {
                    log('Configuration cancelled');
                }
            } catch (error) {
                log(`Error: ${error.message}`);
            }
        }

        async function testWithExistingConfig() {
            log('Setting up test configuration data...');
            CONFIG.set('SUPABASE_URL', 'https://test-project.supabase.co');
            CONFIG.set('SUPABASE_ANON_KEY', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.test-key');
            CONFIG.set('TABLE_NAME', 'test_logs');
            
            await testModal();
        }

        function clearConfig() {
            log('Clearing configuration...');
            localStorage.removeItem('chatsyncer_supabase_url');
            localStorage.removeItem('chatsyncer_supabase_anon_key');
            localStorage.removeItem('chatsyncer_table_name');
            CONFIG.SUPABASE_URL = null;
            CONFIG.SUPABASE_ANON_KEY = null;
            CONFIG.TABLE_NAME = null;
            log('Configuration cleared');
        }

        function showCurrentConfig() {
            log('Current configuration:');
            log(`  URL: ${CONFIG.get('SUPABASE_URL') || 'Not set'}`);
            log(`  Key: ${CONFIG.get('SUPABASE_ANON_KEY') ? '[HIDDEN]' : 'Not set'}`);
            log(`  Table: ${CONFIG.get('TABLE_NAME') || 'Not set'}`);
        }

        // Initialize
        log('Test page loaded. Click buttons to test the modal functionality.');
    </script>
</body>
</html>